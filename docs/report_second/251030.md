# 20251031
1.doris指标sql完成


with t1 as (
select
ds,
str_to_date(window_start,'yyyy-MM-dd HH:mm:ss') as window_start,
str_to_date(window_end,'yyyy-MM-dd HH:mm:ss') as window_end,
win_gmv,
top5_product_ids
from realtime_v3_lululemon.gmv_table
order by ds
),
t2 as (
select ds,window_start,window_end,win_gmv,top5_product_ids
from (
select
*,
row_number() over (partition by ds order by window_end desc) as rn
from t1
)as t2
where rn = 1
),
t3 as (
select *
from (
select ds,
window_start,
window_end,
win_gmv,
product_id
from t2
lateral view explode_split(top5_product_ids,',') tmp as product_id
) as tmp
),
t4 as (
select ds,
window_start,
window_end,
win_gmv,
a.product_id,
b.product_desc
from t3 as a
left join postgresql_catalog.public.spider_lululemon_jd_product_dtl as b
on a.product_id = b.product_id
),
t5 as (
select *
from (
select *,
row_number() over (partition by ds,product_id order by ds ) as rn
from t4
)as tmp
where rn = 1
),
t6 as (
select ds,
window_start,
window_end,
win_gmv,
group_concat(product_desc,',') as product_topN_name,
GROUP_CONCAT(REPLACE(REPLACE(product_id, '\n', ''), ' ', ''), ',') AS product_topN_ids
from t5
group by ds,window_start,window_end,win_gmv
)SELECT
cur.ds,
cur.window_start,
cur.window_end,
cur.win_gmv,
cur.product_topN_name,
CONCAT(
ROUND(
(cur.win_gmv - LAG(cur.win_gmv, 1, 0) OVER (ORDER BY cur.ds)) /
NULLIF(LAG(cur.win_gmv, 1, 0) OVER (ORDER BY cur.ds), 0) * 100,
2),
'%'
) AS mon_rate,
CONCAT(
ROUND(
(
(CASE WHEN FIND_IN_SET(split_part(cur.product_topN_ids, ',', 1), prev.product_topN_ids) > 0 THEN 1 ELSE 0 END) +
(CASE WHEN FIND_IN_SET(split_part(cur.product_topN_ids, ',', 2), prev.product_topN_ids) > 0 THEN 1 ELSE 0 END) +
(CASE WHEN FIND_IN_SET(split_part(cur.product_topN_ids, ',', 3), prev.product_topN_ids) > 0 THEN 1 ELSE 0 END) +
(CASE WHEN FIND_IN_SET(split_part(cur.product_topN_ids, ',', 4), prev.product_topN_ids) > 0 THEN 1 ELSE 0 END) +
(CASE WHEN FIND_IN_SET(split_part(cur.product_topN_ids, ',', 5), prev.product_topN_ids) > 0 THEN 1 ELSE 0 END)
)
/ LEAST(5, LENGTH(cur.product_topN_ids) - LENGTH(REPLACE(cur.product_topN_ids, ',', '')) + 1) * 100,
2),
'%'
) AS similarity_rate
FROM t6 cur
LEFT JOIN t6 prev
ON date_add(prev.ds, interval 1 day) = cur.ds
ORDER BY cur.ds;
